import { useState, useEffect } from 'react'
import { AlertTriangle, Download, Terminal, MessageSquare, CheckCircle, ExternalLink, Code, BookOpen, Shield } from 'lucide-react'
import './ExploitPage.css'

interface ExploitStep {
  title: string;
  description: string;
  code?: string;
}

interface SourceCodeResult {
  file: string;
  path: string;
  lineNumber: number;
  code: string;
  context: string;
  url: string;
  relevance: number;
}

interface ExploitStrategy {
  exploitName: string;
  severity: string;
  description: string;
  payloadFilename: string;
  payloadCode: string;
  steps: ExploitStep[];
  sourceCodeResults?: SourceCodeResult[];
  references?: Array<{ title: string; url: string }>;
  warnings?: string[];
  tips?: string[];
  prerequisites?: string[];
  exploitType?: string;
}

export function ExploitPage() {
  const [strategy, setStrategy] = useState<ExploitStrategy | null>(null)
  const [activeTab, setActiveTab] = useState('overview')
  const [expandedStep, setExpandedStep] = useState<number | null>(null)
  
  useEffect(() => {
    const stored = localStorage.getItem('exploitStrategy')
    if (stored) {
      try {
        const parsed = JSON.parse(stored)
        setStrategy(parsed)
        // Expand first step by default
        if (parsed.steps && parsed.steps.length > 0) {
          setExpandedStep(0)
        }
      } catch (e) {
        console.error("Failed to parse exploit strategy", e)
      }
    }
  }, [])

  const downloadPayload = () => {
    if (!strategy) return
    const blob = new Blob([strategy.payloadCode], { type: 'text/plain' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = strategy.payloadFilename || 'payload.bin'
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  if (!strategy) {
    return (
      <div className="exploit-page">
        <div className="loading-state">
          <Terminal size={48} />
          <p>Loading exploit guide...</p>
        </div>
      </div>
    )
  }

  const severityColors: Record<string, string> = {
    critical: '#f85149',
    high: '#f0883e',
    medium: '#d29922',
    low: '#3fb950',
  }

  return (
    <div className="exploit-page">
      <div className="exploit-header">
        <div className="exploit-title">
          <div className={`icon-wrapper ${strategy.severity}`} style={{ backgroundColor: `${severityColors[strategy.severity]}20`, borderColor: severityColors[strategy.severity] }}>
            <AlertTriangle size={32} color={severityColors[strategy.severity]} />
          </div>
          <div>
            <h1>{strategy.exploitName || "ChromeOS Vulnerability Exploit"}</h1>
            <div className="exploit-meta">
              <span className={`severity-badge ${strategy.severity}`} style={{ backgroundColor: severityColors[strategy.severity] }}>
                {strategy.severity.toUpperCase()} SEVERITY
              </span>
              {strategy.exploitType && (
                <span className="exploit-type-badge">{strategy.exploitType}</span>
              )}
            </div>
            <p className="exploit-description">{strategy.description}</p>
          </div>
        </div>
        <button className="download-btn" onClick={downloadPayload}>
          <Download size={18} /> Download Payload
        </button>
      </div>

      <div className="exploit-content">
        <div className="exploit-sidebar">
          <button 
            className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
            onClick={() => setActiveTab('overview')}
          >
            <BookOpen size={18} /> Overview
          </button>
          <button 
            className={`tab-btn ${activeTab === 'instructions' ? 'active' : ''}`}
            onClick={() => setActiveTab('instructions')}
          >
            <Terminal size={18} /> Step-by-Step Guide
          </button>
          <button 
            className={`tab-btn ${activeTab === 'source' ? 'active' : ''}`}
            onClick={() => setActiveTab('source')}
          >
            <Code size={18} /> Source Code
          </button>
          <button 
            className={`tab-btn ${activeTab === 'payload' ? 'active' : ''}`}
            onClick={() => setActiveTab('payload')}
          >
            <MessageSquare size={18} /> Payload
          </button>
        </div>

        <div className="exploit-panel">
          {activeTab === 'overview' && (
            <div className="overview-view">
              <div className="section">
                <h2>üìã Prerequisites</h2>
                <ul className="prerequisites-list">
                  {(strategy.prerequisites || [
                    'ChromeOS development environment',
                    'Understanding of the vulnerability type',
                    'Access to target system (for testing)',
                    'Knowledge of C/C++ (for most ChromeOS exploits)',
                  ]).map((prereq, idx) => (
                    <li key={idx}>{prereq}</li>
                  ))}
                </ul>
              </div>

              {strategy.warnings && strategy.warnings.length > 0 && (
                <div className="section warnings-section">
                  <h2>‚ö†Ô∏è Important Warnings</h2>
                  <div className="warnings-list">
                    {strategy.warnings.map((warning, idx) => (
                      <div key={idx} className="warning-item">
                        <AlertTriangle size={20} />
                        <span>{warning}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {strategy.tips && strategy.tips.length > 0 && (
                <div className="section tips-section">
                  <h2>üí° Helpful Tips</h2>
                  <ul className="tips-list">
                    {strategy.tips.map((tip, idx) => (
                      <li key={idx}>{tip}</li>
                    ))}
                  </ul>
                </div>
              )}

              {strategy.references && strategy.references.length > 0 && (
                <div className="section references-section">
                  <h2>üìö References</h2>
                  <div className="references-list">
                    {strategy.references.map((ref, idx) => (
                      <a key={idx} href={ref.url} target="_blank" rel="noopener noreferrer" className="reference-link">
                        <ExternalLink size={16} />
                        <span>{ref.title}</span>
                      </a>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {activeTab === 'instructions' && (
            <div className="instructions-view">
              <div className="section-header">
                <h2>üöÄ Step-by-Step Exploitation Guide</h2>
                <p>Follow these steps carefully to exploit the vulnerability</p>
              </div>
              <div className="step-list">
                {strategy.steps.map((step, index) => (
                  <div 
                    key={index} 
                    className={`step-item ${expandedStep === index ? 'expanded' : ''}`}
                    onClick={() => setExpandedStep(expandedStep === index ? null : index)}
                  >
                    <div className="step-header">
                      <div className="step-icon">{index + 1}</div>
                      <div className="step-title-content">
                        <h3>{step.title}</h3>
                        {expandedStep !== index && (
                          <p className="step-preview">{step.description.substring(0, 100)}...</p>
                        )}
                      </div>
                      <CheckCircle size={20} className="step-check" />
                    </div>
                    {expandedStep === index && (
                      <div className="step-details">
                        <p className="step-description">{step.description}</p>
                        {step.code && (
                          <div className="step-code">
                            <pre><code>{step.code}</code></pre>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {activeTab === 'source' && (
            <div className="source-view">
              <div className="section-header">
                <h2>üìÑ ChromeOS Source Code References</h2>
                <p>These are the actual source code locations where the vulnerability was found</p>
              </div>
              {strategy.sourceCodeResults && strategy.sourceCodeResults.length > 0 ? (
                <div className="source-code-list">
                  {strategy.sourceCodeResults.map((result, idx) => (
                    <div key={idx} className="source-code-item">
                      <div className="source-code-header">
                        <div>
                          <h3>
                            <Code size={18} />
                            {result.file}
                          </h3>
                          <p className="source-path">{result.path}</p>
                        </div>
                        <a 
                          href={result.url} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          className="source-link"
                        >
                          <ExternalLink size={16} />
                          View on Chromium
                        </a>
                      </div>
                      <div className="source-code-content">
                        <div className="source-line-info">
                          Line {result.lineNumber} | Relevance: {(result.relevance * 100).toFixed(0)}%
                        </div>
                        <pre className="source-code-block">
                          <code>{result.code || result.context}</code>
                        </pre>
                        {result.context && result.context !== result.code && (
                          <div className="source-context">
                            <strong>Context:</strong> {result.context}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="no-source-code">
                  <Code size={48} />
                  <p>No source code references available</p>
                </div>
              )}
            </div>
          )}

          {activeTab === 'payload' && (
            <div className="payload-view">
              <div className="section-header">
                <h2>üíª Exploit Payload</h2>
                <p>Download and review the exploit payload code</p>
              </div>
              <div className="payload-info">
                <div className="payload-meta">
                  <span><strong>Filename:</strong> {strategy.payloadFilename}</span>
                  <span><strong>Type:</strong> {strategy.exploitType || 'General'}</span>
                </div>
              </div>
              <div className="code-block">
                <div className="code-header">
                  <span>{strategy.payloadFilename}</span>
                  <button onClick={downloadPayload} className="copy-btn">
                    <Download size={16} /> Download
                  </button>
                </div>
                <pre className="code-content">
                  <code>{strategy.payloadCode}</code>
                </pre>
              </div>
              <div className="payload-warning">
                <Shield size={20} />
                <div>
                  <strong>Security Notice:</strong> This exploit is for educational and authorized security testing purposes only. 
                  Unauthorized use of exploits is illegal and unethical.
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}
