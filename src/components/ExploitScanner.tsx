import { useState } from 'react'
import { WebContainer } from '@webcontainer/api'
import { XSSDetector } from '@lib/web-exploitation'
import { SQLInjectionScanner } from '@lib/web-exploitation'
import { SystemLogScanner } from '@lib/chromeos'
import { KernelExploiter } from '@lib/chromeos'
import './ExploitScanner.css'

interface ExploitScannerProps {
  webcontainer: WebContainer | null
}

export function ExploitScanner({ webcontainer }: ExploitScannerProps) {
  const [targetUrl, setTargetUrl] = useState('')
  const [scanning, setScanning] = useState(false)
  const [results, setResults] = useState<any[]>([])

  const handleScan = async () => {
    if (!targetUrl) {
      alert('Please enter a target URL')
      return
    }

    setScanning(true)
    setResults([])

    try {
      const allResults: any[] = []

      // XSS Scan
      const xssDetector = new XSSDetector()
      const xssResults = await xssDetector.scanURL(targetUrl)
      allResults.push(...xssResults.map(r => ({ type: 'XSS', ...r })))

      // SQL Injection Scan
      const sqlScanner = new SQLInjectionScanner()
      const sqlResults = await sqlScanner.scanAPIEndpoint(targetUrl)
      allResults.push(...sqlResults.map(r => ({ type: 'SQL Injection', ...r })))

      // ChromeOS System Logs
      const logScanner = new SystemLogScanner()
      const logResults = await logScanner.scanSystemLogs()
      allResults.push(...logResults.map(r => ({ type: 'System Logs', ...r })))

      // Kernel Exploitation
      const kernelExploiter = new KernelExploiter()
      const kernelResults = await kernelExploiter.scanKernelVulnerabilities()
      allResults.push(...kernelResults.map(r => ({ type: 'Kernel', ...r })))

      setResults(allResults)
    } catch (error) {
      console.error('Scan error:', error)
      alert('Scan failed: ' + (error as Error).message)
    } finally {
      setScanning(false)
    }
  }

  return (
    <div className="exploit-scanner">
      <div className="scanner-input">
        <input
          type="text"
          placeholder="Enter target URL..."
          value={targetUrl}
          onChange={(e) => setTargetUrl(e.target.value)}
          disabled={scanning}
        />
        <button onClick={handleScan} disabled={scanning || !targetUrl}>
          {scanning ? 'Scanning...' : 'Start Scan'}
        </button>
      </div>

      {results.length > 0 && (
        <div className="scan-results">
          <h3>Scan Results ({results.length})</h3>
          <div className="results-list">
            {results.map((result, index) => (
              <div key={index} className={`result-item severity-${result.severity}`}>
                <div className="result-header">
                  <span className="result-type">{result.type}</span>
                  <span className={`severity-badge severity-${result.severity}`}>
                    {result.severity}
                  </span>
                </div>
                <div className="result-description">{result.description}</div>
                {result.location && (
                  <div className="result-location">Location: {result.location}</div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

