import { useState } from 'react'
import { WebContainer } from '@webcontainer/api'
import { XSSDetector } from '@lib/web-exploitation'
import { SQLInjectionScanner } from '@lib/web-exploitation'
import { SystemLogScanner } from '@lib/chromeos'
import { KernelExploiter } from '@lib/chromeos'
import { UnenrollmentExploitDetector } from '@lib/chromeos'
import { OpenMemory } from '@lib/integrations'
import { OpenReason } from '@lib/integrations'
import './ExploitScanner.css'

interface ExploitScannerProps {
  webcontainer: WebContainer | null
}

export function ExploitScanner({ webcontainer: _webcontainer }: ExploitScannerProps) {
  const [targetUrl, setTargetUrl] = useState('')
  const [scanning, setScanning] = useState(false)
  const [results, setResults] = useState<any[]>([])
  const [scanType, setScanType] = useState<'web' | 'chromeos' | 'unenrollment' | 'all'>('all')
  const [memory] = useState(() => new OpenMemory())
  const [reasoner] = useState(() => new OpenReason())

  const handleScan = async () => {
    if (!targetUrl && scanType !== 'unenrollment' && scanType !== 'chromeos') {
      alert('Please enter a target URL')
      return
    }

    setScanning(true)
    setResults([])

    try {
      const allResults: any[] = []

      if (scanType === 'web' || scanType === 'all') {
        if (targetUrl) {
          // XSS Scan
          const xssDetector = new XSSDetector()
          const xssResults = await xssDetector.scanURL(targetUrl)
          allResults.push(...xssResults.map(r => ({ ...r, type: 'XSS' })))

          // SQL Injection Scan
          const sqlScanner = new SQLInjectionScanner()
          const sqlResults = await sqlScanner.scanAPIEndpoint(targetUrl)
          allResults.push(...sqlResults.map(r => ({ ...r, type: 'SQL Injection' })))
        }
      }

      if (scanType === 'chromeos' || scanType === 'all') {
        // ChromeOS System Logs
        const logScanner = new SystemLogScanner()
        const logResults = await logScanner.scanSystemLogs()
        allResults.push(...logResults.map(r => ({ type: 'System Logs', ...r })))

        // Kernel Exploitation
        const kernelExploiter = new KernelExploiter()
        const kernelResults = await kernelExploiter.scanKernelVulnerabilities()
        allResults.push(...kernelResults.map(r => ({ type: 'Kernel', ...r })))
      }

      if (scanType === 'unenrollment' || scanType === 'all') {
        // Unenrollment Exploit Detection
        const unenrollmentDetector = new UnenrollmentExploitDetector()
        const unenrollmentResults = await unenrollmentDetector.scanAllUnenrollmentExploits()
        
        // Store findings in memory
        for (const result of unenrollmentResults) {
          if (result.type === 'oobe') {
            memory.storeOOBEExploit(result.method, result.description, result.severity)
          } else if (result.type === 'server-side') {
            memory.storeServerSideExploit(result.method, result.description, result.severity)
          }
        }
        
        // Reason about exploits
        for (const result of unenrollmentResults.slice(0, 5)) {
          const reasoning = await reasoner.reasonAboutUnenrollmentExploit(
            result.method,
            { type: result.type, severity: result.severity }
          )
          
          allResults.push({
            type: `Unenrollment (${result.type})`,
            method: result.method,
            severity: result.severity,
            description: result.description,
            reasoning: reasoning.conclusion,
            confidence: reasoning.confidence,
            exploitVector: result.exploitVector,
          })
        }
      }

      setResults(allResults)
    } catch (error) {
      console.error('Scan error:', error)
      alert('Scan failed: ' + (error as Error).message)
    } finally {
      setScanning(false)
    }
  }

  return (
    <div className="exploit-scanner">
      <div className="scanner-controls">
        <div className="scan-type-selector">
          <label>Scan Type:</label>
          <select
            value={scanType}
            onChange={(e) => setScanType(e.target.value as any)}
            disabled={scanning}
          >
            <option value="all">All Scans</option>
            <option value="web">Web Exploits</option>
            <option value="chromeos">ChromeOS Exploits</option>
            <option value="unenrollment">Unenrollment Exploits</option>
          </select>
        </div>
      </div>
      <div className="scanner-input">
        <input
          type="text"
          placeholder={scanType === 'unenrollment' ? 'Unenrollment scan (no URL needed)' : 'Enter target URL...'}
          value={targetUrl}
          onChange={(e) => setTargetUrl(e.target.value)}
          disabled={scanning || scanType === 'unenrollment'}
        />
        <button onClick={handleScan} disabled={scanning || (!targetUrl && scanType !== 'unenrollment' && scanType !== 'chromeos')}>
          {scanning ? 'Scanning...' : 'Start Scan'}
        </button>
      </div>

      {results.length > 0 && (
        <div className="scan-results">
          <h3>Scan Results ({results.length})</h3>
          <div className="results-list">
            {results.map((result, index) => (
              <div key={index} className={`result-item severity-${result.severity}`}>
                <div className="result-header">
                  <span className="result-type">{result.type}</span>
                  <span className={`severity-badge severity-${result.severity}`}>
                    {result.severity}
                  </span>
                </div>
                <div className="result-description">{result.description}</div>
                {result.location && (
                  <div className="result-location">Location: {result.location}</div>
                )}
                {result.exploitVector && (
                  <div className="exploit-vector">Exploit Vector: {result.exploitVector}</div>
                )}
                {result.reasoning && (
                  <div className="reasoning">Reasoning: {result.reasoning}</div>
                )}
                {result.confidence && (
                  <div className="confidence">Confidence: {(result.confidence * 100).toFixed(0)}%</div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

