/**
 * Local Storage Manipulation Module
 * Exploit local storage to bypass security measures
 */

export interface LocalStorageVulnerability {
  key: string;
  value: string;
  issue: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
}

export class LocalStorageExploiter {
  /**
   * Scan for sensitive data in local storage
   */
  scanLocalStorage(): LocalStorageVulnerability[] {
    const vulnerabilities: LocalStorageVulnerability[] = [];
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!key) continue;
      
      const value = localStorage.getItem(key);
      if (!value) continue;
      
      // Check for sensitive patterns
      if (this.containsSensitiveData(value)) {
        vulnerabilities.push({
          key,
          value: value.substring(0, 100), // Truncate for display
          issue: 'Contains sensitive data (tokens, passwords, etc.)',
          severity: 'high',
        });
      }
      
      // Check for JSON injection
      if (this.isJSONInjectionVulnerable(value)) {
        vulnerabilities.push({
          key,
          value: value.substring(0, 100),
          issue: 'Vulnerable to JSON injection',
          severity: 'medium',
        });
      }
    }
    
    return vulnerabilities;
  }

  /**
   * Attempt to manipulate local storage
   */
  manipulateStorage(key: string, maliciousValue: string): boolean {
    try {
      localStorage.setItem(key, maliciousValue);
      return true;
    } catch (error) {
      console.error('Failed to manipulate storage:', error);
      return false;
    }
  }

  /**
   * Test for XSS via local storage
   */
  testXSSViaStorage(): LocalStorageVulnerability[] {
    const vulnerabilities: LocalStorageVulnerability[] = [];
    const xssPayloads = [
      '<script>alert("XSS")</script>',
      '<img src=x onerror=alert("XSS")>',
      'javascript:alert("XSS")',
    ];
    
    for (const payload of xssPayloads) {
      const testKey = `test_${Date.now()}`;
      localStorage.setItem(testKey, payload);
      
      const stored = localStorage.getItem(testKey);
      if (stored && stored.includes(payload)) {
        vulnerabilities.push({
          key: testKey,
          value: payload,
          issue: 'XSS payload can be stored and retrieved',
          severity: 'high',
        });
      }
      
      localStorage.removeItem(testKey);
    }
    
    return vulnerabilities;
  }

  /**
   * Check if storage contains sensitive data
   */
  private containsSensitiveData(value: string): boolean {
    const sensitivePatterns = [
      /password/i,
      /token/i,
      /secret/i,
      /api[_-]?key/i,
      /auth/i,
      /credential/i,
      /jwt/i,
      /bearer/i,
      /session/i,
    ];
    
    return sensitivePatterns.some(pattern => pattern.test(value));
  }

  /**
   * Check for JSON injection vulnerability
   */
  private isJSONInjectionVulnerable(value: string): boolean {
    try {
      JSON.parse(value);
      // If it's valid JSON, check if it can be manipulated
      const parsed = JSON.parse(value);
      const testPayload = JSON.stringify({ ...parsed, injected: '<script>alert(1)</script>' });
      JSON.parse(testPayload);
      return true;
    } catch {
      return false;
    }
  }
}

